# Script to create the training file


## 1 - filterByCity.py (optional)
	
Filters the records of a specific city, for example, Curitiba.

```
python <inputfile>  <targetfile> <city>
```

Example:


```
$python waze.gz waze_curitiba.json curitiba
```


## 2 - filterSpatioTemporalData.py (optional)

Filters the records of which are Spatio-Temporal. 


```
$ python <inputfile>  <targetfile>
```



## 3 - CreateGrids.py (mandatory)


First of all, it's necessary create a file with the grids of the desired city. In order to do this, use the program `CreateGrids.py`.

The parameters are:

 * shapefile, s: The Filepath of the shapefile (shp format, but the dbf file must be in the same folder)
 * ngrid, g:	The organization of the grid. Format: \<n\_lines\> \<n\_columns\>  (default, 50x50)


Example: 

```sh
$ python CreateGrids.py -s /var/workspace/curitiba.shp -g 50 50
``` 

The output of this program is a csv file, where each line corresponds to a grid and contains its coordinates, the identification number, and the information whether its valid (inside the city).

The image below is an example that corresponds to the grids for the city of Curitiba (only valid grids).

![](./Curitiba_Grids_Distribuition.jpg)


## 4 - preprocessing.py (mandatory)

Reads the output generated by the previous filter (or the original) and given the selected parameters, assign 1 to the grid in which the record is contained (otherwise, 0). Note: For performance gains, are not considered grids outside the perimeter of the cities.

This step is performed in PyCOMPSs, and in order to execute it, it's necessary that the input file to be read is already divided into numFrag parts (number of cores available). Each of them will have the suffix "\_number". For example, if the user submit a execution with the input file 'input.csv' and numFrag equal to 4, it means that the application will look for the files 'input.csv\_0', 'input.csv\_1', 'input.csv\_2' and 'input.csv\_3'.

The parameters are:

 * input  (-i): The input file path;
 * grids (-g):  The input of the grids list file;
 * window (-w): The window time in seconds to take in count (default, 3600) 
 * numFrag (-f): Number of workers (cores)  


Example of how submit this application in COMPSs, considering the Curitiba's city:

```sh
date
STARTTIME=$(date +%s)

INPUT=$1
runcompss  --lang=python $PWD/preprocessing.py -i $INPUT -g $PWD/Curitiba_Grids.csv -f 4 -w 3600


ENDTIME=$(date +%s)
echo "It took $(($ENDTIME - $STARTTIME)) seconds"
date

```

This application creates the following three files:

1. output\_events.csv:	The number of events recorded at each time point
2. output\_training.csv: The output of the application itself. This file will serve as the entry for the model.


### Requirements files


```
Shapely == 1.6.1
geopy == 1.11.0
numpy == 1.11.0
pandas == 0.20.3
pyshp == 1.2.11
```
